{% extends 'polls/base.html' %}

{% block head %}
    <title>{{ object.question_text }}</title>
    <style>
        body{
            user-select: none;
        }
        p{
            margin: auto;
        }
    </style>
{% endblock %}
{% block content %}
    <div class="container" style="margin-top: 80px;">
        <div class="card" style = 'max-width: 600px;margin: auto'>
           <div class="card-header">User's Side</div>
            <div class="row row-cols-sm-2 row-cols-1 no-gutters">
                <div class="col">
                   <!-- Image section -->
                    <img style="width: 100%;height: 200px" src="{{ object.question_img.url }}" alt="{{ object.question_text }}">
                </div>
                <!-- The area that displays the votes -->
                <div class="col" style = 'padding: 3px;'>
                    <div class="choice-container">
                        {% for choice in object.choice_set.all %}
                            <div class="choice">
                                <p class="mute small">{{ choice.choice_text }}</p>
                                <input type="radio" name="side" value="{{ choice.id }}" style="background: white;margin:0px 2px 0px 0px;cursor: pointer;">
                                <div class="progress" style="cursor: pointer;display: inline-block;width: calc(100% - 25px)">
                                    <div class="progress-bar" role="progressbar" style="width: 50%" aria-valuenow="50" aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                                <p class="mute small votes">{{ choice.votes }} Vote{{ choice.votes|pluralize }}</p>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            <hr style = 'margin: 0px;'/>
            <div class="card-body">
                {% if user.is_authenticated %}
                    <button class="btn disable btn-block btn-outline-dark">Vote</button>
                {% endif %}
            </div>
        </div>
    </div>
{% endblock %}
{% block javascript %}
   <script>
        // A function that adjusts the value of the progress bar
        let adjustProgressbar = () => {
            let positions = [];
            let progressbar = $('.progress-bar');
            $('.choice').each(function(){
                // Get the value of the votes and insert it into a list
                positions.push(Number($(this).find('.votes').text().split(' ')[0]));
            })
            // Find the maximum votes
            let highestVote = Math.max(...positions);
            positions = positions.map(x => Math.round((x/highestVote) * 100));
            // Adjust the progressbar
            for(let ele = 0; ele < progressbar.length; ele++){
                progressbar[ele].innerHTML = `${positions[ele]}%`;
                progressbar[ele].style.width = `${positions[ele]}%`;
            }
            
        }
        adjustProgressbar() // invoke the function
       
       // Create a function that changes the choice of the user even when he clicks on the progressbar
       let changeSidesWhenCliked = () => {
           $('.progress').click(function(){
               $(this).parent().find("input[type = 'radio']").prop('checked',true);
           })
       }
       changeSidesWhenCliked() // invoke the function
       
       // Create a function that makes an ajax request to register a vote for a user
       let registerVote = () => {
           $('button').click(function(){
               let voteId = $('input[name = "side"]:checked').val();
               if(voteId){
                   // Make an ajax request  
                   $.ajax({
                       'url':"{% url 'polls:vote' %}",
                       data : {
                           'choice_id': voteId,
                       },
                       dataType : 'json',
                       success : function(data){
                           // Modify the number of votes for the selected choice
                           $('input[name = "side"]:checked').parent().find('.votes').text(`${data["current_vote"]} Votes`);
                           // Adjust the progressbar 
                           adjustProgressbar()
                           // Deselect the radio button
                           $('input[name = "side"]:checked').prop('checked',false);
                       },
                   })
                }
           })
       }
       registerVote() // invoke the function
   </script>
{% endblock %}